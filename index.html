<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Merry Christmas! A festive holiday greeting card"
    />
    <title>Merry Christmas! üéÑ</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Background Image Container -->
    <div
      class="background-container"
      role="img"
      aria-label="Festive Christmas background"
    ></div>

    <!-- Logo in Top Left Corner -->
    <div class="logo-container">
      <a href="https://hciuse.com" target="_blank" rel="noopener noreferrer">
        <img src="./assets/logo/hciuse.png" alt="Logo" class="site-logo" />
      </a>
    </div>

    <!-- Dancing Elves Container -->
    <div id="elvesContainer" class="elves-container" aria-hidden="true"></div>

    <!-- Snow Fountain Container -->
    <div id="snowFountain" class="snow-fountain" aria-hidden="true"></div>

    <!-- Main Card Content -->
    <main class="card-container">
      <div class="card">
        <!-- Greeting Header -->
        <header class="card__header">
          <h1 class="card__title">Frohe Weihnachten!</h1>
          <p class="card__subtitle">
            Erholsame Feiertage und ein gl√ºckliches neues Jahr.
          </p>
        </header>

        <!-- Main Message -->
        <section class="card__message">
          <p>
            M√∂ge Ihre Weihnachtszeit voller W√§rme, Lachen und Liebe sein. Wir
            w√ºnsche Ihnen und Ihren Lieben eine wundervolle Weihnachtszeit und
            ein gl√ºckliches, gesundes neues Jahr!
          </p>
          <p class="card__signature">
            <span class="card__closing">Mit Liebe und besten W√ºnschen,</span
            ><br />
            <strong>Ihr HCIUSE-Team</strong>
          </p>
        </section>

        <!-- Decorative Elements -->
        <div class="card__decoration" aria-hidden="true">
          <span class="snowflake">‚ùÑ</span>
          <span class="snowflake">‚ùÖ</span>
          <span class="snowflake">‚ùÜ</span>
        </div>
      </div>

      <!-- Audio Controls -->
      <div class="audio-controls">
        <button
          id="audioToggle"
          class="audio-button"
          aria-label="Play Christmas music"
        >
          <span class="play-icon">üéµ</span>
          <span class="button-text">Play Music</span>
        </button>
        <audio id="christmasMusic" loop>
          <source src="./assets/audio/music.mp3" type="audio/mpeg" />
          Your browser does not support the audio element.
        </audio>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <p class="footer__text">Made with ‚ù§Ô∏è for the holidays</p>
    </footer>

    <!-- JavaScript for Audio Control and Dancing Elves -->
    <script>
      // ==========================================
      // CONFIGURATION: Add your face image filenames here!
      // ==========================================
      const FACE_IMAGES = [
        "andr√©.png",
        "leonard2.png",
        "lilian2.png",
        "lukas2.png",
        "maged2.png",
        "marthe2.png",
        "marvin2.png",
        "toni2.png",
      ];

      // ==========================================
      // Audio Control
      // ==========================================
      const audio = document.getElementById("christmasMusic");
      const toggleButton = document.getElementById("audioToggle");
      const buttonText = toggleButton.querySelector(".button-text");
      const playIcon = toggleButton.querySelector(".play-icon");
      let isPlaying = false;

      // Toggle audio play/pause
      toggleButton.addEventListener("click", () => {
        if (isPlaying) {
          audio.pause();
          buttonText.textContent = "Play Music";
          playIcon.textContent = "üéµ";
          toggleButton.setAttribute("aria-label", "Play Christmas music");
          isPlaying = false;
        } else {
          audio.play().catch((error) => {
            console.log("Audio playback failed:", error);
            alert(
              "Unable to play audio. Please check that the music file exists in assets/audio/music.mp3"
            );
          });
          buttonText.textContent = "Pause Music";
          playIcon.textContent = "‚è∏Ô∏è";
          toggleButton.setAttribute("aria-label", "Pause Christmas music");
          isPlaying = true;
        }
      });

      // Handle audio end (shouldn't happen with loop, but just in case)
      audio.addEventListener("ended", () => {
        buttonText.textContent = "Play Music";
        playIcon.textContent = "üéµ";
        toggleButton.setAttribute("aria-label", "Play Christmas music");
        isPlaying = false;
      });

      // Handle errors
      audio.addEventListener("error", (e) => {
        console.error("Audio loading error:", e);
        toggleButton.disabled = true;
        buttonText.textContent = "Music Unavailable";
        toggleButton.classList.add("disabled");
      });

      // ==========================================
      // Dancing Elves
      // ==========================================

      /**
       * Creates a dancing elf with a face photo
       */
      function createElf(faceImagePath, index) {
        const elf = document.createElement("div");
        elf.className = "elf";
        elf.style.animationDelay = `${index * 0.5}s`;

        // Random starting position (keep away from edges)
        const startX = 10 + Math.random() * 70; // 10-80% to stay on screen
        const startY = 10 + Math.random() * 70; // 10-80% to stay on screen
        elf.style.left = `${startX}%`;
        elf.style.top = `${startY}%`;

        // Random animation duration for variety
        const duration = 8 + Math.random() * 4; // 8-12 seconds
        elf.style.animationDuration = `${duration}s`;

        elf.innerHTML = `
                <div class="elf__body">
                    <div class="elf__hat"></div>
                    <div class="elf__face">
                        <img src="${faceImagePath}" alt="Festive elf" class="elf__photo" />
                    </div>
                    <div class="elf__body-main"></div>
                    <div class="elf__legs">
                        <div class="elf__leg elf__leg--left"></div>
                        <div class="elf__leg elf__leg--right"></div>
                    </div>
                </div>
            `;

        return elf;
      }

      /**
       * Initializes all dancing elves
       */
      function initElves() {
        if (FACE_IMAGES.length === 0) {
          console.log(
            "No face images configured. Add filenames to FACE_IMAGES array in index.html"
          );
          return;
        }

        const container = document.getElementById("elvesContainer");

        FACE_IMAGES.forEach((filename, index) => {
          const imagePath = `./assets/images/faces/${filename}`;
          const elf = createElf(imagePath, index);

          // Check if image loads successfully
          const img = elf.querySelector(".elf__photo");
          img.addEventListener("error", () => {
            console.error(`Failed to load face image: ${filename}`);
            // Optionally remove the elf if image fails to load
            // elf.remove();
          });

          container.appendChild(elf);
        });

        console.log(`Created ${FACE_IMAGES.length} dancing elves!`);
      }

      // ==========================================
      // Snow Fountain (follows mouse cursor)
      // ==========================================

      const snowFountain = document.getElementById("snowFountain");
      let lastMouseX = 0;
      let lastMouseY = 0;
      let isMouseMoving = false;
      let fountainInterval = null;

      // Track mouse position
      document.addEventListener("mousemove", (e) => {
        lastMouseX = e.clientX;
        lastMouseY = e.clientY;

        if (!isMouseMoving) {
          isMouseMoving = true;
          startSnowFountain();
        }
      });

      // Stop fountain when mouse stops moving
      let mouseStopTimeout;
      document.addEventListener("mousemove", () => {
        clearTimeout(mouseStopTimeout);
        mouseStopTimeout = setTimeout(() => {
          isMouseMoving = false;
          stopSnowFountain();
        }, 5000);
      });

      function startSnowFountain() {
        if (fountainInterval) return;

        fountainInterval = setInterval(() => {
          if (isMouseMoving) {
            createSnowParticle(lastMouseX, lastMouseY);
          }
        }, 30); // Create particle every 50ms
      }

      function stopSnowFountain() {
        if (fountainInterval) {
          clearInterval(fountainInterval);
          fountainInterval = null;
        }
      }

      function createSnowParticle(x, y) {
        const particle = document.createElement("div");
        particle.className = "snow-particle";

        // Random fountain angle (upward cone)
        const angle = (Math.random() * 60 - 30) * (Math.PI / 180); // -30 to +30 degrees
        const velocity = -400 + Math.random() * 400; // pixels per second

        // Calculate velocity components
        const vx = Math.sin(angle) * velocity;
        const vy = -Math.abs(Math.cos(angle)) * velocity; // Always upward

        // Random particle characteristics
        const size = 4 + Math.random() * 6; // 4-10px
        const rotation = Math.random() * 360;
        const duration = 3 + Math.random() * 0.5; // 1-1.5 seconds

        // Style the particle
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.setProperty("--vx", `${vx}px`);
        particle.style.setProperty("--vy", `${vy}px`);
        particle.style.setProperty("--rotation", `${rotation}deg`);
        particle.style.animationDuration = `${duration}s`;

        // Add to DOM
        snowFountain.appendChild(particle);

        // Remove after animation completes
        setTimeout(() => {
          particle.remove();
        }, duration * 1100);
      }

      // ==========================================
      // URL Parameter Handling (Base64 Encoded)
      // ==========================================

      /**
       * Decodes base64 encoded URL parameter and updates card text
       */
      function loadCustomTextFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedMsg = urlParams.get("msg");

        if (!encodedMsg) {
          return; // No custom message, use defaults
        }

        console.log("Custom message parameter found in URL");
        console.log("Decoding custom message...", encodedMsg);

        try {
          // Decode base64
          const decodedJSON = atob(encodedMsg);
          console.log("Decoded custom message JSON:", decodedJSON);
          const customText = JSON.parse(decodedJSON);

          // Update title if provided
          if (customText.title) {
            const titleElement = document.querySelector(".card__title");
            if (titleElement) titleElement.textContent = customText.title;
          }

          // Update subtitle if provided
          if (customText.subtitle) {
            const subtitleElement = document.querySelector(".card__subtitle");
            if (subtitleElement)
              subtitleElement.textContent = customText.subtitle;
          }

          // Update main message if provided
          if (customText.message) {
            const messageElement = document.querySelector(
              ".card__message p:first-child"
            );
            if (messageElement) messageElement.textContent = customText.message;
          }

          // Update closing text if provided (e.g., "With love and best wishes,")
          if (customText.closing) {
            const closingElement = document.querySelector(".card__closing");
            if (closingElement) closingElement.textContent = customText.closing;
          }

          // Update signature if provided
          if (customText.signature) {
            const signatureElement = document.querySelector(
              ".card__signature strong"
            );
            if (signatureElement)
              signatureElement.textContent = customText.signature;
          }

          console.log("Custom text loaded from URL parameters");
        } catch (error) {
          console.error("Failed to decode URL parameters:", error);
          console.log("Using default text");
        }
      }

      // ==========================================
      // Initialize on page load
      // ==========================================
      window.addEventListener("load", () => {
        document.body.classList.add("loaded");
        loadCustomTextFromURL();
        initElves();
      });
    </script>
  </body>
</html>
